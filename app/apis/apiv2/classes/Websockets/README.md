A more advanced implementation of websockets.

The websocket functionality in the first version of the api is not suitable for production